<!DOCTYPE html>
<html>
<head>
  <title>RaspiKids</title>
  <style type="text/css">
  g,
  g text {
  	cursor: pointer;
  }
  circle.end {
  	fill: #D94747;
  }
  
  circle.start {
  	fill: #56D947;
  }
  
  circle {
  	fill: #E8E8E8;
  }
  
  circle.dragging {
  	fill: #FFFACF;
  }
  
  line {
  	stroke: rgb(6,120,155);
  }
  
  div.wfHolder {
  	position: absolute;
  	top: 90px;
  	bottom: 0;
  	left: 0;
  	right: 0;
  	z-index: 100;
  }
  
  div.menu {
  	position: absolute;
  	z-index: 1000;
  }
  </style>
</head>
<body>
<input id="start_btn" type="button" value="Start"/>
<div class="menu">
	<ul id="allWorkflows"></ul>
</div>
<div class="wfHolder">
	<svg id="graph">
	</svg>
</div>
<script>
window.onload = function(){
	const spawn = require('child_process').spawn;
	
	var currentChildProcess;
	
	var d3 = require('d3');

	var workflowDir = 'wf/';

	var fs = require('fs');
	
	var loadedWF = null;

	fs.readdir(workflowDir, function (err, data) {
		if (err) throw err;
		
		var ul = d3.select("#allWorkflows");
		for(var i in data){
			var fileName = data[i];
			var li = ul.append('li');
			li.text(fileName);
			li.on('click', function(){
				loadedWF = this.textContent;
				loadWorkflow(this.textContent);
			});
		}
	});
	
	d3.select("#start_btn").on('click', function(){
		if(loadedWF){
			if(currentChildProcess){
				console.log("child process already running kill it!");
				currentChildProcess.kill();
			}
			
			console.log("starting child process");
			currentChildProcess = spawn('raspi-kids-wf', [loadedWF.replace('.json','')]);
			
			currentChildProcess.stdout.on('data', (data) => {
				  console.log(`stdout: ${data}`);
			});
			
			currentChildProcess.stderr.on('data', (data) => {
				  console.log(`stderr: ${data}`);
			});
			
			currentChildProcess.on('close', (code) => {
				  console.log(`child process exited with code ${code}`);
			});
			
			/*var init = require("../wf_engine.js");

			init.startWF(loadedWF.replace('.json',''));*/
		}
	});

	var vis = d3.select("#graph");

	var loadWorkflow = function(textContent){
		vis.html('');
		var w = '100%', h = '100%';
		vis.attr("width", w)
		   .attr("height", h);

		var data = require('../' + workflowDir + textContent);

		var nodes = [];

		var links = [];

		//make array of WF and links
		for(var k in data){
			var o = data[k];
			o.id = k;
			nodes.push(o);
			
			if(o.data && o.data.out){
				for(var i in o.data.out){
					var outObject = o.data.out[i];
					var link = {
							source: o,
							target: data[outObject.target]
						};
					links.push(link);
				}
			}
		}
		
		var determineClass = function(d){
			if(d.meta_data.end)
				return 'end';
			else if(d.meta_data.start)
    			return 'start';
			return '';
		};
		
		var drag = d3.behavior.drag()
	    	.on('dragstart', function(d) {
	    		var group = d3.select(this);
	    		group.selectAll('circle').attr('class', 'dragging');
	    	})
	    	.on('drag', function(d) {
	    		var group = d3.select(this);
	    		d.meta_data.x = d3.event.x;
	    		d.meta_data.y = d3.event.y;
	    		group.attr('transform', "translate("+d.meta_data.x+","+d.meta_data.y+")");
	    		
	    		vis.selectAll("line")
	    		   .data(links).attr("x1", function(d) { 
	    				return d.source.meta_data.x 
	    			})
	    			.attr("y1", function(d) { 
	    				return d.source.meta_data.y 
	    			})
	    			.attr("x2", function(d) { 
	    				return d.target.meta_data.x 
	    			})
	    			.attr("y2", function(d) { 
	    				return d.target.meta_data.y 
	    			});
	    	})
	    	.on('dragend', function(d) { 
	    		var group = d3.select(this);
	    		group.selectAll('circle').attr('class', determineClass);
	    		console.log(data);
	    	});
		
		vis.selectAll(".line")
			.data(links)
			.enter()
			.append("line")
			.attr("x1", function(d) { 
				return d.source.meta_data.x 
			})
			.attr("y1", function(d) { 
				return d.source.meta_data.y 
			})
			.attr("x2", function(d) { 
				return d.target.meta_data.x 
			})
			.attr("y2", function(d) { 
				return d.target.meta_data.y 
			});
		
		var elem = vis.selectAll("g")
			.data(nodes);
		
		var elemEnter = elem.enter()
	        .append("g")
	        .attr("transform", function(d){return "translate("+d.meta_data.x+","+d.meta_data.y+")"})
	        .call(drag);
		
		var circle = elemEnter.append("circle")
	        .attr("r", "30px")
	        .attr("class", determineClass);
		
		elemEnter.append("text")
	        .attr("dx", function(d){return -10})
	        .text(function(d){return d.id});
	}
};
</script>  
</body>
</html>