<!DOCTYPE html>
<html>
<head>
<title>RaspiKids</title>
<style type="text/css">
g,g text {
	cursor: pointer;
}

circle.end {
	fill: #D94747;
}

circle.start {
	fill: #56D947;
}

circle {
	fill: #E8E8E8;
}

circle.selected {
	fill: #FFFACF;
}

line {
	stroke: rgb(6, 120, 155);
}

.link {
	fill: none;
	stroke: #666;
	stroke-width: 1.5px;
	-webkit-svg-shadow: 0 1px 0 #fff;
}

div.wfHolder {
	position: absolute;
	top: 90px;
	bottom: 0;
	left: 0;
	right: 0;
	z-index: 100;
}

div.menu {
	position: absolute;
	z-index: 1000;
}
</style>
</head>
<body>
	<input id="start_btn" type="button" value="Start" />
	<div class="menu">
		<ul id="allWorkflows"></ul>
	</div>
	<div class="wfHolder">
		<svg id="graph">
	</svg>
	</div>
	<script>
window.onload = function(){
	const spawn = require('child_process').spawn;
	
	var circleRadius = 30;
	
	var selectedNode;
	
	var currentChildProcess;
	
	var d3 = require('d3');

	var workflowDir = 'wf/';

	var fs = require('fs');
	
	var loadedWF = null;

	fs.readdir(workflowDir, function (err, data) {
		if (err) throw err;
		
		var ul = d3.select("#allWorkflows");
		for(var i in data){
			var fileName = data[i];
			var li = ul.append('li');
			li.text(fileName);
			li.on('click', function(){
				loadedWF = this.textContent;
				loadWorkflow(this.textContent);
			});
		}
	});
	
	d3.select("#start_btn").on('click', function(){
		if(loadedWF){
			if(currentChildProcess){
				console.log("child process already running kill it!");
				currentChildProcess.kill();
			}
			
			console.log("starting child process");
			currentChildProcess = spawn('raspi-kids-wf', [loadedWF.replace('.json','')]);
			
			currentChildProcess.stdout.on('data', (data) => {
				  console.log(`stdout: ${data}`);
			});
			
			currentChildProcess.stderr.on('data', (data) => {
				  console.log(`stderr: ${data}`);
			});
			
			currentChildProcess.on('close', (code) => {
				  console.log(`child process exited with code ${code}`);
			});
			
			/*var init = require("../wf_engine.js");

			init.startWF(loadedWF.replace('.json',''));*/
		}
	});

	var vis = d3.select("#graph");

	var loadWorkflow = function(textContent){
		vis.html('');
		
		vis.append("defs").selectAll("marker")
    			.data(["suit", "licensing", "resolved"])
	  		.enter().append("marker")
	    		.attr("id", function(d) { return d; })
	    		.attr("viewBox", "0 -5 10 10")
			    .attr("refX", 15)
			    .attr("refY", -1.5)
			    .attr("markerWidth", 6)
			    .attr("markerHeight", 6)
			    .attr("orient", "auto")
			.append("path")
			    .attr("d", "M0,-5L10,0L0,5");
		
		var w = '100%', h = '100%';
		vis.attr("width", w)
		   .attr("height", h);
		
		vis.on('click', function(){
			//reset selected class
    		if(!d3.event.defaultPrevented && selectedNode && selectedNode != this){
    			selectedNode.selectAll('circle').attr('class', determineClass);
    			selectedNode = null;
    		}
		});

		var data = require('../' + workflowDir + textContent);

		var nodes = [];

		var links = [];

		//make array of WF and links
		for(var k in data){
			var o = data[k];
			o.id = k;
			nodes.push(o);
			
			if(o.data && o.data.out){
				for(var i in o.data.out){
					var outObject = o.data.out[i];
					var link = {
							source: o,
							target: data[outObject.target]
						};
					links.push(link);
				}
			}
		}
		
		var determineClass = function(d){
			if(d.meta_data.end)
				return 'end';
			else if(d.meta_data.start)
    			return 'start';
			return '';
		};
		
		var drag = d3.behavior.drag()
	    	.on('dragstart', function(d) {
	    		//reset selected class
	    		if(selectedNode){
	    			selectedNode.selectAll('circle').attr('class', determineClass);
	    		}
	    		
	    		var group = d3.select(this);
	    		group.selectAll('circle').attr('class', 'selected');
	    		
	    		selectedNode = group;
	    	})
	    	.on('drag', function(d) {
	    		var group = d3.select(this);
	    		d.meta_data.x = d3.event.x;
	    		d.meta_data.y = d3.event.y;
	    		group.attr('transform', "translate("+d.meta_data.x+","+d.meta_data.y+")");
	    		
	    		vis.selectAll(".link")
	    		   .data(links).attr("d", linkArc);
	    	})
	    	.on('dragend', function(d) { 
	    		/*var group = d3.select(this);
	    		group.selectAll('circle').attr('class', determineClass);
	    		console.log(data);*/
	    	});
	    	
	    var elem = vis.selectAll(".node")
			.data(nodes);
		
		var elemEnter = elem.enter()
	        .append("g")
	        .attr("transform", function(d){return "translate("+d.meta_data.x+","+d.meta_data.y+")"})
	        .attr("class", "node")
	        .call(drag)
	        .on('click', function(){
	        	d3.event.stopPropagation();
	        	if(!d3.event.defaultPrevented){
	        		if(selectedNode){
		    			selectedNode.selectAll('circle').attr('class', determineClass);
		    		}
		    		
		    		var group = d3.select(this);
		    		group.selectAll('circle').attr('class', 'selected');
		    		
		    		selectedNode = group;
	    		}
	        });
		
		var circle = elemEnter.append("circle")
	        .attr("r", circleRadius + "px")
	        .attr("class", determineClass);
		
		elemEnter.append("text")
	        .attr("dx", function(d){return -10})
	        .text(function(d){return d.id});
	    	
	    var linkArc = function(d){
  			var dx = d.target.meta_data.x - d.source.meta_data.x,
			dy = d.target.meta_data.y - d.source.meta_data.y,
			//dr = Math.sqrt(dx * dx + dy * dy);
			dr = 100;
			return "M" + d.source.meta_data.x + "," + d.source.meta_data.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.meta_data.x + "," + d.target.meta_data.y;
	    };
		
		var path = vis.append("g").selectAll("path")
    		.data(links)
  			.enter().append("path")
    		.attr("class", function(d) { return "link"; })
    		.attr("marker-end", function(d) { return "url(#suit)"; })
    		.attr("d", linkArc);
	}
};
</script>
</body>
</html>